import{d as z,u as F,r as n,j as c,b as s,C as M}from"./index-ac63b8d3.js";import{u as J}from"./useRemainingViewPortHeight-5e23aa2b.js";function N(){const[m,H]=J(),{t:a}=F(),[l,$]=n.useState(()=>localStorage.getItem("subscribe_url")||""),[_,x]=n.useState("加载配置中..."),[p,g]=n.useState({visible:!1,type:"success",title:"",message:""}),[b,h]=n.useState(!1),[w,S]=n.useState(null),d=n.useCallback(async(e,t={})=>{const i=e.startsWith("http")?e:window.location.origin+e;try{console.log(`尝试请求: ${e}, 完整URL: ${i}`);const o=await fetch(e,t);if(o.ok)return console.log(`直接请求成功: ${e}`),o;console.log(`直接请求失败，尝试完整URL: ${i}`);const u=await fetch(i,t);if(u.ok)return console.log(`完整URL请求成功: ${i}`),u;throw new Error("所有请求方式都失败")}catch(o){return console.error("请求失败:",o,"尝试使用XMLHttpRequest"),new Promise((u,y)=>{const r=new XMLHttpRequest;r.open(t.method||"GET",e),t.headers&&Object.entries(t.headers).forEach(([D,W])=>{r.setRequestHeader(D,W)}),r.onload=()=>{r.status>=200&&r.status<300?(console.log(`XHR请求成功: ${e}`),u({ok:!0,status:r.status,text:()=>Promise.resolve(r.responseText),json:()=>Promise.resolve(JSON.parse(r.responseText))})):y(new Error(`XHR请求失败: ${r.status}`))},r.onerror=()=>y(new Error("XHR网络错误")),t.body instanceof FormData?r.send(t.body):r.send()})}},[]),v=n.useCallback(async()=>{try{const t=await(await d("/sub/health")).json();return S(JSON.stringify(t,null,2)),t}catch(e){return console.error("健康检查失败:",e),S(`健康检查失败: ${e instanceof Error?e.message:"未知错误"}`),null}},[d]),R=n.useCallback(async()=>{try{return console.log("直接请求配置文件..."),await(await d("/sub/get_config")).text()}catch(e){throw console.error("直接获取配置失败:",e),e}},[d]),f=n.useCallback(async()=>{try{const e=await v();if(console.log("健康检查结果:",e),e&&e.config_exists&&e.config_size>0){console.log("配置文件存在，直接获取配置内容");const t=await R();x(t)}else console.log("配置文件不存在或为空"),x("当前没有可用配置 - 请更新订阅")}catch(e){console.error("配置加载错误:",e),x("获取配置失败 - 请检查连接")}},[v,R]);n.useEffect(()=>{f()},[f]),n.useEffect(()=>{l&&localStorage.setItem("subscribe_url",l)},[l]);const L=async()=>{h(!0);try{const e=await d("/sub/reload_config",{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!e.ok)throw new Error(`HTTP错误 ${e.status}`);const t=await e.json();g({visible:!0,type:t.status,title:t.status==="success"?"成功":"错误",message:t.message}),t.status==="success"&&await f()}catch(e){g({visible:!0,type:"error",title:"错误",message:`热加载失败: ${e instanceof Error?e.message:"未知错误"}`})}finally{h(!1)}},T=async e=>{if(e.preventDefault(),!l){g({visible:!0,type:"error",title:"错误",message:"请输入订阅地址"});return}h(!0);try{console.log("准备提交表单...");const t=new FormData;t.append("subscribe_url",l),console.log("发送请求到:","/sub/update_config");const i=await d("/sub/update_config",{method:"POST",body:t,headers:{"X-Requested-With":"XMLHttpRequest"}});let o;try{o=await i.json()}catch(u){console.error("解析响应JSON失败:",u);const y=await i.text();throw console.log("响应文本:",y),new Error("服务器响应格式错误")}console.log("收到响应:",o),g({visible:!0,type:o.status==="success"?"success":o.status==="warning"?"warning":"error",title:o.status==="success"?"成功":o.status==="warning"?"警告":"错误",message:o.message}),o.status==="success"&&(console.log("提交成功，准备重新加载配置"),setTimeout(f,1e3))}catch(t){console.error("提交错误:",t),g({visible:!0,type:"error",title:"错误",message:`请求失败: ${t instanceof Error?t.message:"未知错误"}`})}finally{h(!1)}},U={height:`${H}px`,overflow:"auto",padding:"20px"},k={background:"white",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0, 0, 0, 0.1)",marginBottom:"20px",overflow:"hidden"},C={padding:"20px"},X={marginBottom:"20px"},j={display:"block",marginBottom:"8px",fontWeight:"bold",color:"#2c3e50"},q={width:"100%",padding:"12px 15px",border:"1px solid #ddd",borderRadius:"4px",fontSize:"16px"},E={padding:"12px 24px",background:"#3498db",color:"white",border:"none",borderRadius:"4px",fontSize:"16px",cursor:"pointer"},B={...k,borderLeft:`4px solid ${p.type==="success"?"#2ecc71":p.type==="warning"?"#f39c12":"#e74c3c"}`,display:p.visible?"block":"none"},P={border:"1px solid #ddd",borderRadius:"4px",padding:"10px",backgroundColor:"#f8f9fa",maxHeight:"300px",overflow:"auto"},I={margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word"},O={marginTop:"20px",padding:"10px",backgroundColor:"#f8f9fa",border:"1px solid #ddd",borderRadius:"4px",fontSize:"12px",display:w?"block":"none"};return c("div",{children:[s(M,{title:a("订阅")}),c("div",{ref:m,style:U,children:[s("div",{style:k,children:s("div",{style:C,children:c("form",{onSubmit:T,children:[c("div",{style:X,children:[s("label",{style:j,htmlFor:"subscribe_url",children:a("订阅地址 (SUBSCRIBE_URL)")}),s("input",{id:"subscribe_url",type:"text",value:l,onChange:e=>$(e.target.value),placeholder:a("请输入您的订阅地址"),required:!0,style:q})]}),c("div",{style:{textAlign:"center",display:"flex",gap:"10px"},children:[s("button",{type:"submit",style:E,disabled:b,children:a(b?"更新中...":"更新配置")}),s("button",{type:"button",onClick:L,style:{...E,background:"#27ae60"},disabled:b,children:a(b?"加载中...":"热加载配置")})]})]})})}),s("div",{style:B,children:c("div",{style:C,children:[s("h3",{children:a(p.title)}),s("p",{children:a(p.message)})]})}),c("div",{children:[s("h3",{style:{marginBottom:"10px"},children:a("当前配置文件内容")}),s("div",{style:P,children:s("pre",{style:I,children:_})})]}),c("div",{style:O,children:[s("h4",{children:"服务器状态:"}),s("pre",{children:w})]})]})]})}const G=m=>({}),K=z(G)(N);export{K as default};
